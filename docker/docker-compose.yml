# =============================================================================
# fq-compressor Docker Compose Configuration
# =============================================================================
# 项目名称，避免与其他项目冲突
name: fqcompressor

services:
  # ===========================================================================
  # 开发环境
  # ===========================================================================
  dev:
    image: fqcompressor-dev:latest
    pull_policy: never
    build:
      context: ..
      dockerfile: docker/Dockerfile.dev
      target: development
      args:
        - USE_CHINA_MIRROR=${USE_CHINA_MIRROR:-0}
        - HTTP_PROXY=${DEVCONTAINER_HTTP_PROXY:-}
        - HTTPS_PROXY=${DEVCONTAINER_HTTPS_PROXY:-}
        - ALL_PROXY=${DEVCONTAINER_ALL_PROXY:-}
        - NO_PROXY=${DEVCONTAINER_NO_PROXY:-localhost,127.0.0.1,10.0.0.0/8,172.16.0.0/12,192.168.0.0/16,.local,host.docker.internal}
    # container_name 已移除，避免与手动启动的容器冲突
    # VS Code devcontainer 会自动管理容器名
    volumes:
      - ..:/workspace:cached
      - conan_cache:/home/developer/.conan2:cached
      - ccache_cache:/home/developer/.ccache:cached
      - vscode_extensions:/home/developer/.vscode-server/extensions:cached
      - ${FQCOMPRESSOR_HOST_DATA_DIR:-/tmp/fqcompressor-data}:/data:cached
    ports:
      - "${FQCOMPRESSOR_SSH_BIND:-127.0.0.1}:${FQCOMPRESSOR_SSH_PORT:-2222}:${FQCOMPRESSOR_SSH_PORT:-2222}"
    environment:
      - FQCOMPRESSOR_SSH_PORT=${FQCOMPRESSOR_SSH_PORT:-2222}
      - TERM=xterm-256color
    stdin_open: true
    tty: true
    init: true
    command: /bin/bash
    working_dir: /workspace
    # 安全配置
    security_opt:
      - seccomp:unconfined
    cap_add:
      - SYS_PTRACE
    # 健康检查
    healthcheck:
      test: ["CMD", "pgrep", "-x", "bash"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  # ===========================================================================
  # 生产环境
  # ===========================================================================
  prod:
    image: fqcompressor-prod:latest
    build:
      context: ..
      dockerfile: docker/Dockerfile
      target: production
      args:
        - USE_CHINA_MIRROR=${USE_CHINA_MIRROR:-0}
    container_name: fqcompressor-prod
    volumes:
      - ./data:/app/data:ro
      - ./output:/app/output
    environment:
      - FQCOMPRESSOR_DATA_DIR=/app/data
      - FQCOMPRESSOR_OUTPUT_DIR=/app/output
    restart: unless-stopped
    read_only: true
    tmpfs:
      - /tmp:size=100M
    healthcheck:
      test: ["CMD", "fqc", "--help"]
      interval: 60s
      timeout: 10s
      retries: 3

  # ===========================================================================
  # 测试环境
  # ===========================================================================
  test:
    image: fqcompressor-test:latest
    build:
      context: ..
      dockerfile: docker/Dockerfile.dev
      target: development
      args:
        - USE_CHINA_MIRROR=${USE_CHINA_MIRROR:-0}
    container_name: fqcompressor-test
    volumes:
      - ..:/workspace:cached
      - conan_cache:/home/developer/.conan2:cached
      - ccache_cache:/home/developer/.ccache:cached
    environment:
      - BUILD_TYPE=Debug
      - ENABLE_COVERAGE=ON
      - TERM=xterm-256color
    command: /workspace/scripts/test.sh
    working_dir: /workspace
    init: true

  # ===========================================================================
  # 构建服务
  # ===========================================================================
  build:
    image: fqcompressor-build:latest
    build:
      context: ..
      dockerfile: docker/Dockerfile
      target: build
      args:
        - USE_CHINA_MIRROR=${USE_CHINA_MIRROR:-0}
    container_name: fqcompressor-build
    volumes:
      - ..:/workspace:cached
      - conan_cache:/root/.conan2:cached
      - ccache_cache:/root/.ccache:cached
    command: /workspace/scripts/build.sh --release
    working_dir: /workspace
    init: true

# =============================================================================
# Named Volumes - 持久化缓存
# =============================================================================
volumes:
  conan_cache:
    name: fqcompressor_conan_cache
  ccache_cache:
    name: fqcompressor_ccache_cache
  vscode_extensions:
    name: fqcompressor_vscode_extensions
